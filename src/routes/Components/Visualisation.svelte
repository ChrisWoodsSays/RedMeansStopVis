<script lang="ts">
    // @ts-nocheck
	import { getStopSignPoints } from "../utils/getData";
	import { onMount } from "svelte";
	import { gsap } from "gsap";
	import * as d3 from 'd3';
	import { rmsRed, rmsAmber, rmsGreen, rmsBlue } from '../utils/colours';
	import { tooltipable } from '../actions/tooltipable';
	import { fade } from 'svelte/transition';

    const speed = 1;
 	export let selectedLocationShortName;
	export let currentStep;

	export let surveys = [];
	export let locations = [];
	export let people = [];

	let previousLocation = "";

    $: margin = { top: 150, right: 50, bottom: 50, left: 50 }

	export let width;
	export let height;
	// $: console.log(width, height);
    export let tooltipTarget;
	export let allowMapDrag;

	console.log(people)

	let trafficLightCentreHeight, availableHeight, availableWidth, lightRadius, lightSeparation, gantryWidth, amberLightY, redLightY, greenLightY, gantryY, gantryHeight, postY, allLightX, hourCircleX, categoryTextX;

	$: {

		availableHeight = (height - margin.top - margin.bottom)*1;
		availableWidth = width - margin.left - margin.right;
		trafficLightCentreHeight = margin.top + availableHeight * 1/2;
		lightRadius = availableHeight * 1.5 / 12;
		lightSeparation = availableHeight / 3.9;
		gantryWidth = lightRadius * 2;
		amberLightY = trafficLightCentreHeight;
		redLightY = amberLightY - lightSeparation;
		greenLightY = amberLightY + lightSeparation;
		gantryY = redLightY - lightRadius - 10;
		gantryHeight = 2 * (lightSeparation + lightRadius) + 20;
		postY = gantryY + gantryHeight + 10;
		allLightX = availableWidth /2 + margin.left;
		hourCircleX = margin.left + lightRadius*2;
		categoryTextX = allLightX + gantryWidth/2 +40;
	}

	// Setup Traffic Light Points (for inside circles)
	let neutralColour = "#DCDCDC";
	let redPoints,  amberPoints, greenPoints , allTLPoints = [];
	let c=5;

	$: totalRedSurveys = surveys.filter(s => s.colourName == "Red").length;
	$: {
		redPoints = getStopSignPoints(c, 5, surveys.filter(s => s.colourName == "Red"), totalRedSurveys, rmsRed, neutralColour, redLightY );
	 	amberPoints = getStopSignPoints(c, 5, surveys.filter(s => s.colourName == "Amber"), totalRedSurveys, rmsAmber, neutralColour, amberLightY );
	 	greenPoints = getStopSignPoints(c, 5, surveys.filter(s => s.colourName == "Green"), totalRedSurveys, rmsGreen, neutralColour, greenLightY );
	 	allTLPoints = redPoints.concat(amberPoints).concat(greenPoints);
	}

	$: console.log(surveys.filter(d => d.lat == 0))

	// Scales
	$: xLonScale = d3
      .scaleLinear()
      .domain(d3.extent(surveys, d => d.lon))
      .range([margin.left, width - margin.right]);
	$: yLatScale = d3
      .scaleLinear()
      .domain(d3.extent(surveys, d => d.lat))
      .range([margin.top, height - margin.bottom]);

	$: console.log("domain", yLatScale.domain())
	$: console.log("range",yLatScale.range())

	$: circleScale = d3
      .scaleLinear()
      .domain([0,20])
      .range([0, (height - margin.top - margin.bottom)/40]);

	$: phylloScale = d3
		.scaleLinear()
		.domain(d3.extent(allTLPoints, p => p.x))
		.range([-lightRadius * 0.85, lightRadius * 0.85]);

	// $: forceScale = d3
	// 	.scaleLinear()
	// 	.domain(d3.extent(renderedCircles, rc => rc.x))
	// 	.range([-lightRadius * 0.85, lightRadius * 0.85]);

	const noOfTLCirclesLeftToRight = 32;
	$: xRedJumpsScale = d3
      .scaleLinear()
      .domain([0, noOfTLCirclesLeftToRight])
      .range([margin.left + lightRadius*4, width - margin.right]);

	$: yRedJumpsScale = d3
      .scaleLinear()
      .domain([0,548/noOfTLCirclesLeftToRight])
      .range([margin.top+lightRadius, height - margin.bottom]);

	function TLforceOffsetY(colourName: string) {
		switch(colourName) {
			case "Red":
				return redLightY;
				break;
			case "Amber":
				return amberLightY;
				break;
			default:
				return greenLightY;
			}
		}

	const move = (x, y) => `transform: translate(${x}px, ${y}px`

	// Centre TL Points
	$: surveys.forEach(s => {
		s.x = allLightX;
		s.y = amberLightY;
	})

	// Centre Upper Points
		$: people.forEach(s => {
		s.x = allLightX;
		s.y = amberLightY;
	})

	let renderedCircles = [], upperRenderedCircles = [];
0;

	const upperCircleRadius = 40;
	$: upperSimulation = d3.forceSimulation(people)
		.force("x", d3.forceX((d) => {
			return xLonScale(d.lon)
			}).strength(0.3))
		
		.force("y", d3.forceY((d) => {
			//return yScale(d.redLightsPerJump);
			return yLatScale(d.lat)
			}).strength(0.3))
		
		.force("collide", d3.forceCollide((d) => {
			return circleScale(upperCircleRadius*1);
			}))
		
		.alphaDecay(0)
		.alpha(0.3)
		.on("tick", () => {
			upperRenderedCircles = [... people]
		});

	$: upperSimulationInit_decay = setTimeout(function (height) {;
			upperSimulation.alphaDecay(0.1);
		}, 1000); // start decay after 3 seconds

	$: {
		upperSimulation.alpha(0.2)
		upperSimulation.restart()
	}

	$: TLsimulation = d3.forceSimulation(surveys)
		.force("x", d3.forceX((d) => {
			return allLightX;
			}).strength(0.3))
		
		.force("y", d3.forceY((d) => {
			//return yScale(d.redLightsPerJump);
			return TLforceOffsetY(d.colourName)
			}).strength(0.3))
		
		.force("collide", d3.forceCollide((d) => {
			return circleScale(17);
			}))
		
		.alphaDecay(0)
		.alpha(0.3)
		.on("tick", () => {
			renderedCircles = [... surveys]
		});

	$: TLinit_decay = setTimeout(function (height) {
		console.log("start alpha decay");
		TLsimulation.alphaDecay(0.1);
		}, 1000); // start decay after 3 seconds

	$: {
		TLsimulation.alpha(0.2)
    	TLsimulation.restart()
	}

	onMount(
		async () => {
		}
	)

	let innerWidth=0
	//$: console.log(width, innerWidth, height)

	function handleClick() {
		alert('no more alerts');
	}

	// $: console.log(upperRenderedCircles);

</script>
<svelte:window bind:innerWidth = {innerWidth} />


<div class="row">
	<!-- <div class = "logo">
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 288 82"><path d="M80.37 43.3h8.45c5.12 0 9.1 1.41 9.1 6.12 0 2.21-1.24 4.57-3.25 5.33v.15c2.52.65 4.47 2.51 4.47 5.81 0 5.02-4.25 7.27-9.62 7.27h-9.15V43.3Zm8.19 9.89c2.71 0 3.91-1.14 3.91-2.94 0-1.9-1.26-2.64-3.87-2.64h-2.65v5.58h2.61Zm.51 10.49c3.04 0 4.61-1.08 4.61-3.33s-1.54-3.05-4.61-3.05h-3.12v6.37h3.12ZM102.39 43.54c0-1.71 1.36-2.91 3.22-2.91s3.22 1.2 3.22 2.91-1.36 2.91-3.22 2.91-3.22-1.22-3.22-2.91Zm.43 5.66h5.57v18.79h-5.57V49.2ZM113.27 49.2h4.54l.4 3.28h.14c1.37-2.51 3.42-3.74 5.34-3.74 1.07 0 1.7.14 2.24.38l-.93 4.8c-.67-.16-1.22-.3-2.03-.3-1.42 0-3.14.91-4.14 3.47v10.89h-5.57V49.19ZM128.35 49.2h4.54l.4 2.41h.14c1.54-1.55 3.23-2.87 5.69-2.87 2.64 0 4.24 1.14 5.19 3.16 1.65-1.72 3.42-3.16 5.9-3.16 4.06 0 5.88 2.88 5.88 7.58v11.67h-5.57V57.04c0-2.7-.74-3.55-2.32-3.55-.94 0-2.01.59-3.2 1.83V68h-5.57V57.05c0-2.7-.74-3.55-2.32-3.55-.93 0-2.01.59-3.2 1.83v12.68h-5.57V49.22ZM160.37 43.54c0-1.71 1.36-2.91 3.22-2.91s3.22 1.2 3.22 2.91-1.36 2.91-3.22 2.91-3.22-1.22-3.22-2.91Zm.43 5.66h5.57v18.79h-5.57V49.2ZM171.26 49.2h4.54l.4 2.38h.14c1.58-1.52 3.48-2.83 6.04-2.83 4.09 0 5.83 2.88 5.83 7.58V68h-5.57V57.05c0-2.7-.73-3.55-2.33-3.55-1.4 0-2.25.65-3.48 1.83v12.68h-5.57V49.22ZM191.77 71.21c0-1.56.94-2.82 2.67-3.78v-.15c-.97-.66-1.72-1.64-1.72-3.19 0-1.35.9-2.68 2.09-3.52v-.15c-1.32-.92-2.52-2.68-2.52-4.87 0-4.51 3.73-6.8 7.77-6.8 1.05 0 2.07.17 2.91.46h6.87v4.06h-3.02c.35.56.64 1.49.64 2.48 0 4.32-3.29 6.31-7.4 6.31-.69 0-1.46-.12-2.29-.37-.46.4-.65.73-.65 1.4 0 .93.76 1.38 2.81 1.38h3.05c4.61 0 7.17 1.41 7.17 4.78 0 3.9-4.07 6.75-10.52 6.75-4.37 0-7.86-1.42-7.86-4.76Zm13.05-1.03c0-1.18-1.02-1.46-2.86-1.46h-1.95c-1.29 0-2.02-.08-2.63-.24-.69.59-1.02 1.17-1.02 1.84 0 1.42 1.65 2.16 4.17 2.16s4.3-1 4.3-2.3Zm-2.19-14.64c0-2-1.09-3.06-2.57-3.06s-2.57 1.05-2.57 3.06 1.1 3.13 2.57 3.13 2.57-1.07 2.57-3.13ZM213.15 41.45h5.57v6.48l-.25 3.4c1.41-1.28 3.24-2.6 5.8-2.6 4.09 0 5.83 2.88 5.83 7.58v11.67h-5.57V57.03c0-2.7-.73-3.55-2.33-3.55-1.4 0-2.25.65-3.48 1.83v12.68h-5.57V41.46ZM233.91 62.78c0-3.96 3.15-6.1 10.58-6.89-.11-1.64-.93-2.72-2.97-2.72-1.58 0-3.15.66-4.97 1.7l-1.98-3.66c2.38-1.46 5.07-2.47 8.03-2.47 4.8 0 7.46 2.74 7.46 8.5v10.74h-4.54l-.4-1.92h-.14c-1.58 1.39-3.35 2.38-5.47 2.38-3.43 0-5.6-2.5-5.6-5.67Zm10.58-.25v-3.28c-3.96.53-5.25 1.67-5.25 3.09 0 1.21.83 1.8 2.16 1.8s2.11-.62 3.09-1.61ZM254.74 49.2h4.54l.4 2.41h.14c1.54-1.55 3.23-2.87 5.69-2.87 2.64 0 4.24 1.14 5.19 3.16 1.65-1.72 3.42-3.16 5.9-3.16 4.06 0 5.88 2.88 5.88 7.58v11.67h-5.57V57.04c0-2.7-.74-3.55-2.32-3.55-.94 0-2.01.59-3.2 1.83V68h-5.57V57.05c0-2.7-.74-3.55-2.32-3.55-.93 0-2.01.59-3.2 1.83v12.68h-5.57V49.22Z" style="fill:#2b2b2b"></path><g><path d="M81.26 15.06h5.42c4.03 0 6.61 1.53 6.61 4.87 0 2.09-1.08 3.76-3.1 4.37v.12c2.6.44 4.34 2.06 4.34 4.84 0 3.86-2.93 5.84-7.46 5.84h-5.81V15.06Zm4.86 8.82c4.11 0 5.78-1.45 5.78-3.82 0-2.8-1.94-3.84-5.62-3.84h-3.63v7.66h3.46Zm.58 10.06c3.99 0 6.44-1.44 6.44-4.66 0-2.88-2.34-4.25-6.44-4.25h-4.05v8.91h4.05ZM97.46 27.84c0-4.76 3.1-7.7 6.37-7.7 3.46 0 5.59 2.46 5.59 6.76 0 .37-.01.73-.08 1.09H98.83c.05 3.69 2.21 6.32 5.5 6.32 1.58 0 2.83-.52 3.93-1.3l.55 1.02c-1.15.72-2.46 1.44-4.61 1.44-3.73 0-6.75-2.87-6.75-7.64Zm10.7-.95c0-3.73-1.69-5.59-4.32-5.59-2.47 0-4.7 2.09-5.01 5.59h9.32ZM113.42 31.08v-9.4h-2.28v-1.05l2.31-.13.17-4.23h1.14v4.23h4.23v1.17h-4.23v9.5c0 1.86.47 3.12 2.48 3.12.54 0 1.3-.23 1.83-.46l.35 1.09c-.85.3-1.78.55-2.39.55-2.8 0-3.63-1.78-3.63-4.4ZM122.31 31.08v-9.4h-2.28v-1.05l2.31-.13.17-4.23h1.14v4.23h4.24v1.17h-4.24v9.5c0 1.86.47 3.12 2.48 3.12.54 0 1.3-.23 1.83-.46l.35 1.09c-.85.3-1.78.55-2.39.55-2.8 0-3.63-1.78-3.63-4.4ZM129.9 27.84c0-4.76 3.1-7.7 6.37-7.7 3.46 0 5.59 2.46 5.59 6.76 0 .37-.01.73-.08 1.09h-10.51c.05 3.69 2.21 6.32 5.5 6.32 1.58 0 2.83-.52 3.93-1.3l.55 1.02c-1.15.72-2.46 1.44-4.61 1.44-3.73 0-6.75-2.87-6.75-7.64Zm10.7-.95c0-3.73-1.69-5.59-4.32-5.59-2.47 0-4.7 2.09-5.01 5.59h9.32ZM145.82 20.5h1.14l.15 2.73h.07c.99-1.79 2.42-3.09 4.16-3.09.53 0 .97.07 1.45.3l-.3 1.22c-.49-.18-.76-.24-1.32-.24-1.31 0-2.87 1-3.99 3.76v9.94h-1.34V20.51ZM160.15 32.46l.9-.96c1.45 1.65 3.55 2.71 5.88 2.71 3.06 0 4.99-1.64 4.99-4.03s-1.63-3.3-3.61-4.19l-3.04-1.36c-1.75-.77-4.07-2.02-4.07-4.99s2.5-4.94 5.83-4.94c2.42 0 4.36 1.1 5.59 2.4l-.81.93c-1.17-1.25-2.77-2.06-4.78-2.06-2.65 0-4.42 1.42-4.42 3.58 0 2.34 2 3.22 3.47 3.87l3.03 1.35c2.25 1 4.22 2.24 4.22 5.31s-2.53 5.4-6.41 5.4c-2.93 0-5.19-1.24-6.77-3.02ZM177.1 31.08v-9.4h-2.28v-1.05l2.31-.13.17-4.23h1.14v4.23h4.24v1.17h-4.24v9.5c0 1.86.47 3.12 2.48 3.12.54 0 1.3-.23 1.83-.46l.35 1.09c-.85.3-1.78.55-2.39.55-2.8 0-3.63-1.78-3.63-4.4ZM186.25 20.5h1.14l.15 2.73h.07c.99-1.79 2.42-3.09 4.16-3.09.53 0 .97.07 1.45.3l-.3 1.22c-.49-.18-.76-.24-1.32-.24-1.31 0-2.87 1-3.99 3.76v9.94h-1.34V20.51ZM194.36 27.84c0-4.76 3.1-7.7 6.37-7.7 3.46 0 5.59 2.46 5.59 6.76 0 .37-.01.73-.08 1.09h-10.51c.05 3.69 2.21 6.32 5.5 6.32 1.58 0 2.83-.52 3.93-1.3l.55 1.02c-1.15.72-2.46 1.44-4.61 1.44-3.73 0-6.75-2.87-6.75-7.64Zm10.7-.95c0-3.73-1.69-5.59-4.32-5.59-2.47 0-4.7 2.09-5.01 5.59h9.32ZM209.06 27.84c0-4.76 3.1-7.7 6.37-7.7 3.46 0 5.59 2.46 5.59 6.76 0 .37-.01.73-.08 1.09h-10.51c.05 3.69 2.21 6.32 5.5 6.32 1.58 0 2.83-.52 3.93-1.3l.55 1.02c-1.15.72-2.46 1.44-4.61 1.44-3.73 0-6.75-2.87-6.75-7.64Zm10.7-.95c0-3.73-1.69-5.59-4.32-5.59-2.47 0-4.7 2.09-5.01 5.59h9.32ZM225.02 31.08v-9.4h-2.28v-1.05l2.31-.13.17-4.23h1.14v4.23h4.23v1.17h-4.23v9.5c0 1.86.47 3.12 2.48 3.12.54 0 1.3-.23 1.83-.46l.35 1.09c-.85.3-1.78.55-2.39.55-2.8 0-3.63-1.78-3.63-4.4ZM232.05 33.46l.78-.98c1.24 1.03 2.56 1.85 4.64 1.85 2.3 0 3.49-1.34 3.49-2.88 0-1.83-1.89-2.64-3.58-3.24-2.2-.78-4.66-1.68-4.66-4.17 0-2.11 1.67-3.89 4.71-3.89 1.56 0 3.11.65 4.17 1.51l-.72.97c-.99-.74-2.02-1.33-3.49-1.33-2.28 0-3.31 1.31-3.31 2.66 0 1.67 1.72 2.3 3.46 2.96 2.26.86 4.77 1.61 4.77 4.45 0 2.2-1.76 4.12-4.92 4.12-2.17 0-4.05-.91-5.36-2.02ZM250.47 20.63l2.04-.13h4.69v1.17h-6.73v-1.05Zm2.01-3.38c0-2.9 1.3-4.39 3.62-4.39.69 0 1.46.2 2.13.49l-.36 1.1c-.6-.29-1.2-.41-1.74-.41-1.58 0-2.29 1.2-2.29 3.31v17.77h-1.34V17.25ZM258.74 27.84c0-4.89 3.05-7.7 6.56-7.7s6.56 2.81 6.56 7.7-3.05 7.64-6.56 7.64-6.56-2.81-6.56-7.64Zm11.71 0c0-3.85-2.2-6.51-5.15-6.51s-5.15 2.67-5.15 6.51 2.2 6.46 5.15 6.46 5.15-2.61 5.15-6.46ZM276.25 20.5h1.14l.15 2.73h.07c.99-1.79 2.42-3.09 4.16-3.09.53 0 .97.07 1.45.3l-.3 1.22c-.49-.18-.76-.24-1.32-.24-1.31 0-2.87 1-3.99 3.76v9.94h-1.34V20.51Z" style="fill:#2b2b2b"></path></g><g><circle cx="54.19" cy="24.81" r="16.87" style="fill:#e52421;stroke:#fff;stroke-miterlimit:10;stroke-width:4.52px"></circle><circle cx="54.66" cy="24.79" r="7.06" style="fill:#fff"></circle></g><g><circle cx="23.01" cy="56.44" r="16.87" style="fill:#58b031;stroke:#fff;stroke-miterlimit:10;stroke-width:4.52px"></circle><circle cx="22.76" cy="56.69" r="7.06" style="fill:#fff"></circle></g><g><circle cx="54.01" cy="56.39" r="16.87" style="fill:#243f92;stroke:#fff;stroke-miterlimit:10;stroke-width:4.52px"></circle><circle cx="54.03" cy="56.87" r="7.06" style="fill:#fff"></circle></g><g><circle cx="22.38" cy="25.22" r="16.87" style="fill:#ffd503;stroke:#fff;stroke-miterlimit:10;stroke-width:4.52px"></circle><circle cx="22.13" cy="24.97" r="7.06" style="fill:#fff"></circle></g><g><circle cx="39.06" cy="39.94" r="16.87" style="fill:#2b2b2b;stroke:#fff;stroke-miterlimit:10;stroke-width:4.52px"></circle><circle cx="39.01" cy="39.99" r="7.06" style="fill:#fff"></circle></g></svg>
	</div> -->
    <div class = "box">
        <svg viewBox="0 0 {width} {height}" xmlns="http://www.w3.org/2000/svg">

			<!-- Upper Force Formation -->
			{#if currentStep > 0 && currentStep < 499}
				<g class = "UpperForce" transition:fade={{ delay: 1250, duration: 1000 }}>
					{#each upperRenderedCircles as rc, i}
						<circle 
							use:tooltipable={{
								data: { id: rc.id, shortName: rc.shortName, surveyDate: rc.surveyDate, minutesSurveyed: rc.minutesSurveyed, noOfPhases: rc.noOfPhases, 
									redLightsPerJump: rc.redLightsPerJump, minutesPerJump: rc.minutesPerJump, meaning: rc.meaning, colourCode: rc.colourCode},
								chartWidth: width,
								target: tooltipTarget
							}}
							style="{move(currentStep == 1 ? rc.x : margin.left + width /2, currentStep == 1 ? rc.y : margin.top + height /2)}" 
							r={currentStep < 4 ? circleScale(upperCircleRadius* 0.9) : 0} 
							fill = {rmsBlue} stroke-width = {circleScale(1.5)} stroke="white">
						</circle>
					{/each}
				</g>
			{/if}

			<!-- IsoType Red Lights -->
			<!-- {#if currentStep == 4}
				<g transform="translate({margin.left*0}, {margin.top*0})"
				   transition:fade={{ delay: 250, duration: 1000 }}>
					{#each {length: 548} as _, i}
						<circle 
							transition:fade={{ delay: 250+i*10, duration: 300 }}
							cx={xRedJumpsScale(Math.round(i % noOfTLCirclesLeftToRight))} cy={yRedJumpsScale(Math.floor(i /noOfTLCirclesLeftToRight))} r={circleScale(18)} fill = {rmsRed} fill-opacity = 1 stroke = "white" stroke-width=1.5></circle>
					{/each}
				</g>
			{/if} -->

			{#if currentStep == 4}
				<!-- Total No of Red Jumps -->
				<g transition:fade={{ delay: 250, duration: 1000 }}>
					<!-- Hour / Locations Circle -->
					<circle cx={hourCircleX} cy={margin.top + availableHeight/2} r={lightRadius*1.2} stroke = "#243f92" stroke-width="0" fill={rmsRed}/>
					<text y={margin.top + availableHeight/2} dy="0">
						<tspan x={hourCircleX} class = "CircleHeading" dy="-0.1em">548</tspan>
						<tspan x={hourCircleX} class = "CircleText" dy="1.9em">Red Jumps</tspan>
						<tspan x={hourCircleX} class = "CircleText CircleSubText" dy="5.2em">{locations.length} Junctions</tspan>
						<tspan x={hourCircleX} class = "CircleText CircleSubText" dy="1.2em">One Hour</tspan>
					</text>
				</g>
			{/if}

			{#if currentStep >= 5}
				<g transition:fade={{ delay: 1250, duration: 1000 }}>
					<!-- Traffic Light Inside Shape -->
					<rect x={allLightX - gantryWidth/2 - 10} y={gantryY} width={gantryWidth+20} height={gantryHeight} stroke = "#DCDCDC" stroke-width="2" rx = "10" fill="transparent"/>
					<!-- Traffic Light Outside Shape -->
					<rect x={allLightX - gantryWidth/2 - 20} y={gantryY-10} width={gantryWidth+40} height={gantryHeight+20} stroke = "#DCDCDC" stroke-width="2" rx = "20" fill="transparent"/>
					<!-- Traffic Light Post -->
					<rect x={allLightX - gantryWidth/10} y={postY} width={gantryWidth/5} height={gantryHeight} stroke = "#DCDCDC" stroke-width="2" fill="transparent"/>
					<!-- Green -->
					<circle cx={allLightX} cy={redLightY} r={lightRadius} stroke = "#e52421" stroke-width="0" fill={rmsRed} fill-opacity=0.4/>
				</g>
			{/if}
			{#if currentStep >= 6}
				<g transition:fade={{ delay: 250, duration: 1000 }}>
					<!-- Amber -->
					<circle cx={allLightX} cy={amberLightY} r={lightRadius} stroke = "#ffd503" stroke-width="0" fill={rmsAmber} fill-opacity=0.4/>
				</g>
			{/if}
			{#if currentStep >= 7}
				<g transition:fade={{ delay: 250, duration: 1000 }}>
					<!-- Red -->
					<circle cx={allLightX} cy={greenLightY} r={lightRadius} stroke = "#58b031" stroke-width="0" fill={rmsGreen} fill-opacity=0.4/>
				</g>
			{/if}


			<!-- Phyllotaxis Formation -->
			<!-- <g transform="translate({margin.left*0}, {margin.top*0})">
				{#each allPoints as p, i}
					<circle 
						use:tooltipable={{
							data: { id: p.id, shortName: p.shortName, surveyDate: p.surveyDate, minutesSurveyed: p.minutesSurveyed, noOfPhases: p.noOfPhases, 
								redLightsPerJump: p.redLightsPerJump, minutesPerJump: p.minutesPerJump, meaning: p.meaning, colourCode: p.colourCode},
							chartWidth: width,
							target: tooltipTarget
						}}
						cx={allLightX + phylloScale(p.x)} cy={p.yCentre + phylloScale(p.y)}
						r={circleScale(8)} stroke-width = {circleScale(1)}
						fill = {p.colour} >
					</circle>
				{/each}
			</g> -->


			<!-- Force TL Formation -->
			<g transition:fade={{ delay: 1250, duration: 1000 }}>
				{#each renderedCircles as rc, i}
					<circle 
						class = "step{rc.colourName}"
						use:tooltipable={{
							data: { id: rc.id, shortName: rc.shortName, surveyDate: rc.surveyDate, minutesSurveyed: rc.minutesSurveyed, noOfPhases: rc.noOfPhases, 
								redLightsPerJump: rc.redLightsPerJump, minutesPerJump: rc.minutesPerJump, meaning: rc.meaning, colourCode: rc.colourCode},
							chartWidth: width,
							target: tooltipTarget
						}}
						style="{move(rc.x, rc.y)}" 
						r={currentStep > 5 ? circleScale(17) : 0} 
						fill = {rc.colourCode} stroke-width = {circleScale(1.5)} stroke="white">
					</circle>
				{/each}
			</g>

		</svg>

    </div>

</div>

<style>
	text {
    	font-family: var(--font);
		font-size: 0.9vw;
		dominant-baseline:middle;
		fill: var(--foregroundColour);
	}

	.CategoryHeading {
		font-size: 1.0vw;
		font-weight: 400;
		line-height: 30%;
	}

	.CircleHeading {
		fill:white;
		font-size: 3.5vw;
		font-weight: 400;
		text-anchor: middle;
	}

	.SurveyHeading {
		font-size: 1.3vw;
		font-weight: 400;
		text-anchor: middle;
	}

	.CircleText {
		fill:white;
		font-size: 1.1vw;
		font-weight: 400;
		text-anchor: middle;
	}

	.CircleSubText {
		font-size: 1.3vw;
		fill:var(--foregroundColour);
	}

</style>